# **控制节点**

## 1，创库授权

```shell
CREATE DATABASE nova_api;
CREATE DATABASE nova;
GRANT ALL PRIVILEGES ON nova_api.* TO 'nova'@'localhost' \
  IDENTIFIED BY 'NOVA_DBPASS';
GRANT ALL PRIVILEGES ON nova_api.* TO 'nova'@'%' \
  IDENTIFIED BY 'NOVA_DBPASS';
GRANT ALL PRIVILEGES ON nova.* TO 'nova'@'localhost' \
  IDENTIFIED BY 'NOVA_DBPASS';
GRANT ALL PRIVILEGES ON nova.* TO 'nova'@'%' \
  IDENTIFIED BY 'NOVA_DBPASS';
```

## 2,  创建用户 和 关联角色

```shell
openstack user create --domain default \
  --password NOVA_PASS nova
openstack role add --project service --user nova admin
```

## 3, 创建服务  ，注册API

```shell
openstack service create --name nova \
  --description "OpenStack Compute" compute
openstack endpoint create --region RegionOne \
  compute public http://controller:8774/v2.1/%\(tenant_id\)s
 openstack endpoint create --region RegionOne \
  compute internal http://controller:8774/v2.1/%\(tenant_id\)s
openstack endpoint create --region RegionOne \
  compute admin http://controller:8774/v2.1/%\(tenant_id\)s
```

## 4,安装相关软件

```shell
yum install openstack-nova-api openstack-nova-conductor \
  openstack-nova-console openstack-nova-novncproxy \
  openstack-nova-scheduler -y
```

## 5，配置文件  /etc/nova/nova.conf

```shell
vim  nova

openstack-config  --set  /etc/nova/nova.conf DEFAULT enabled_apis osapi_compute,metadata
openstack-config  --set  /etc/nova/nova.conf DEFAULT rpc_backend rabbit
openstack-config  --set  /etc/nova/nova.conf DEFAULT auth_strategy keystone
openstack-config  --set  /etc/nova/nova.conf DEFAULT my_ip 10.0.0.11
openstack-config  --set  /etc/nova/nova.conf DEFAULT use_neutron True
openstack-config  --set  /etc/nova/nova.conf DEFAULT firewall_driver nova.virt.firewall.NoopFirewallDriver
openstack-config  --set  /etc/nova/nova.conf api_database connection mysql+pymysql://nova:NOVA_DBPASS@controller/nova_api
openstack-config  --set  /etc/nova/nova.conf database connection mysql+pymysql://nova:NOVA_DBPASS@controller/nova
openstack-config  --set  /etc/nova/nova.conf oslo_messaging_rabbit rabbit_host controller
openstack-config  --set  /etc/nova/nova.conf oslo_messaging_rabbit rabbit_userid openstack
openstack-config  --set  /etc/nova/nova.conf oslo_messaging_rabbit rabbit_password RABBIT_PASS
openstack-config  --set  /etc/nova/nova.conf keystone_authtoken auth_uri http://controller:5000
openstack-config  --set  /etc/nova/nova.conf keystone_authtoken auth_url http://controller:35357
openstack-config  --set  /etc/nova/nova.conf keystone_authtoken memcached_servers controller:11211
openstack-config  --set  /etc/nova/nova.conf keystone_authtoken auth_type password
openstack-config  --set  /etc/nova/nova.conf keystone_authtoken project_domain_name default
openstack-config  --set  /etc/nova/nova.conf keystone_authtoken user_domain_name default
openstack-config  --set  /etc/nova/nova.conf keystone_authtoken project_name service
openstack-config  --set  /etc/nova/nova.conf keystone_authtoken username nova
openstack-config  --set  /etc/nova/nova.conf keystone_authtoken password NOVA_PASS
openstack-config  --set  /etc/nova/nova.conf vnc vncserver_listen '$my_ip'
openstack-config  --set  /etc/nova/nova.conf vnc vncserver_proxyclient_address '$my_ip'
openstack-config  --set  /etc/nova/nova.conf glance api_servers http://controller:9292 
openstack-config  --set  /etc/nova/nova.conf oslo_concurrency lock_path /var/lib/nova/tmp
```

```shell
sh   nova
```

## 6,同步数据库

```shell
su -s /bin/sh -c "nova-manage api_db sync" nova

su -s /bin/sh -c "nova-manage db sync" nova
```

```shell
[root@controller ~]# mysql nova -e 'show tables;'
+--------------------------------------------+
| Tables_in_nova                             |
+--------------------------------------------+
| agent_builds                               |
| aggregate_hosts                            |
.......
| volume_id_mappings                         |
| volume_usage_cache                         |
+--------------------------------------------+
[root@controller ~]# 
[root@controller ~]# mysql nova_api -e 'show tables;'
+--------------------+
| Tables_in_nova_api |
+--------------------+
| build_requests     |
......
| request_specs      |
+--------------------+
```





## 7,启动服务

```shell
systemctl enable openstack-nova-api.service \
  openstack-nova-consoleauth.service openstack-nova-scheduler.service \
  openstack-nova-conductor.service openstack-nova-novncproxy.service
systemctl start openstack-nova-api.service \
  openstack-nova-consoleauth.service openstack-nova-scheduler.service \
  openstack-nova-conductor.service openstack-nova-novncproxy.service
```





## 查看

```shell
[root@controller ~]# nova service-list 
+----+------------------+------------+----------+---------+-------+----------------------------+-----------------+
| Id | Binary           | Host       | Zone     | Status  | State | Updated_at                 | Disabled Reason |
+----+------------------+------------+----------+---------+-------+----------------------------+-----------------+
| 1  | nova-conductor   | controller | internal | enabled | up    | 2021-09-06T05:12:35.000000 | -               |
| 2  | nova-consoleauth | controller | internal | enabled | up    | 2021-09-06T05:12:35.000000 | -               |
| 4  | nova-scheduler   | controller | internal | enabled | up    | 2021-09-06T05:12:35.000000 | -               |
+----+------------------+------------+----------+---------+-------+----------------------------+-----------------+
```











